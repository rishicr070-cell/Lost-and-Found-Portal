<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>

<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-bug"></i> Notification System Test</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>Instructions:</strong> Open the browser console (F12) to see detailed logs.
                        </div>

                        <!-- User Status -->
                        <div class="mb-4">
                            <h5>1. Authentication Status</h5>
                            <div id="authStatus" class="alert alert-secondary">
                                <i class="bi bi-hourglass-split"></i> Checking...
                            </div>
                        </div>

                        <!-- Notification Container Check -->
                        <div class="mb-4">
                            <h5>2. Notification Container</h5>
                            <div id="containerStatus" class="alert alert-secondary">
                                <i class="bi bi-hourglass-split"></i> Checking...
                            </div>
                        </div>

                        <!-- Firestore Connection -->
                        <div class="mb-4">
                            <h5>3. Firestore Connection</h5>
                            <div id="firestoreStatus" class="alert alert-secondary">
                                <i class="bi bi-hourglass-split"></i> Checking...
                            </div>
                        </div>

                        <!-- Notification Query -->
                        <div class="mb-4">
                            <h5>4. Notification Query Test</h5>
                            <button id="testQueryBtn" class="btn btn-primary mb-2" disabled>
                                <i class="bi bi-search"></i> Test Query
                            </button>
                            <div id="queryStatus" class="alert alert-secondary">
                                Click the button to test notification query
                            </div>
                        </div>

                        <!-- Create Test Notification -->
                        <div class="mb-4">
                            <h5>5. Create Test Notification</h5>
                            <button id="createTestBtn" class="btn btn-success mb-2" disabled>
                                <i class="bi bi-plus-circle"></i> Create Test Notification
                            </button>
                            <div id="createStatus" class="alert alert-secondary">
                                Click the button to create a test notification
                            </div>
                        </div>

                        <!-- All Notifications -->
                        <div class="mb-4">
                            <h5>6. All Your Notifications</h5>
                            <button id="loadAllBtn" class="btn btn-info mb-2" disabled>
                                <i class="bi bi-list"></i> Load All Notifications
                            </button>
                            <div id="allNotifications" class="alert alert-secondary">
                                Click the button to see all notifications
                            </div>
                        </div>

                        <!-- Back to Portal -->
                        <div class="text-center mt-4">
                            <a href="index.html" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left"></i> Back to Portal
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Console Output -->
                <div class="card shadow mt-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Console Output</h5>
                    </div>
                    <div class="card-body bg-dark text-light"
                        style="font-family: monospace; max-height: 400px; overflow-y: auto;">
                        <div id="consoleOutput">Waiting for tests...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAALYUIoqn14jmUnDZB0ORkpBsFrivzLlU",
            authDomain: "lostfoundportal-dsa.firebaseapp.com",
            projectId: "lostfoundportal-dsa",
            storageBucket: "lostfoundportal-dsa.firebasestorage.app",
            messagingSenderId: "1032918662830",
            appId: "1:1032918662830:web:d2a2fae6b1f656cc0eb73f",
            measurementId: "G-TZR77G82ZG"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Console output helper
        function log(message, type = 'info') {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            }[type] || 'ℹ️';

            const line = `<div class="mb-1">[${timestamp}] ${icon} ${message}</div>`;
            output.innerHTML += line;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // Update status helper
        function updateStatus(elementId, message, type = 'secondary') {
            const element = document.getElementById(elementId);
            const classes = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info',
                'secondary': 'alert-secondary'
            };
            element.className = `alert ${classes[type]}`;
            element.innerHTML = message;
        }

        // Test 1: Check Authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                log(`User logged in: ${user.email}`, 'success');
                updateStatus('authStatus', `<i class="bi bi-check-circle"></i> Logged in as: <strong>${user.email}</strong>`, 'success');

                // Enable test buttons
                document.getElementById('testQueryBtn').disabled = false;
                document.getElementById('createTestBtn').disabled = false;
                document.getElementById('loadAllBtn').disabled = false;

                runTests(user);
            } else {
                log('No user logged in', 'error');
                updateStatus('authStatus', '<i class="bi bi-x-circle"></i> Not logged in. Please <a href="login.html">login</a> first.', 'error');
            }
        });

        // Run automatic tests
        function runTests(user) {
            // Test 2: Check Notification Container
            setTimeout(() => {
                log('Checking for notification container element...', 'info');
                // We're on test page, so container won't exist
                updateStatus('containerStatus',
                    '<i class="bi bi-info-circle"></i> Not on main page. Container check skipped.',
                    'info');
            }, 500);

            // Test 3: Check Firestore Connection
            setTimeout(async () => {
                try {
                    log('Testing Firestore connection...', 'info');
                    const testDoc = await db.collection('items').limit(1).get();
                    log(`Firestore connected! Found ${testDoc.size} items`, 'success');
                    updateStatus('firestoreStatus',
                        `<i class="bi bi-check-circle"></i> Connected to Firestore. Found ${testDoc.size} items.`,
                        'success');
                } catch (error) {
                    log(`Firestore error: ${error.message}`, 'error');
                    updateStatus('firestoreStatus',
                        `<i class="bi bi-x-circle"></i> Error: ${error.message}`,
                        'error');
                }
            }, 1000);
        }

        // Test 4: Query Notifications
        document.getElementById('testQueryBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            log('Testing notification query...', 'info');
            updateStatus('queryStatus', '<i class="bi bi-hourglass-split"></i> Querying...', 'info');

            try {
                const snapshot = await db.collection('notifications')
                    .where('originalPosterEmail', '==', user.email)
                    .where('status', '==', 'pending')
                    .get();

                log(`Query successful! Found ${snapshot.size} pending notifications`, 'success');

                let html = `<i class="bi bi-check-circle"></i> Found <strong>${snapshot.size}</strong> pending notifications<br>`;

                if (snapshot.size > 0) {
                    html += '<ul class="mt-2 mb-0">';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        html += `<li>${data.itemName} - claimed by ${data.claimerEmail}</li>`;
                        log(`  - ${data.itemName} claimed by ${data.claimerEmail}`, 'info');
                    });
                    html += '</ul>';
                }

                updateStatus('queryStatus', html, 'success');
            } catch (error) {
                log(`Query error: ${error.message}`, 'error');
                updateStatus('queryStatus', `<i class="bi bi-x-circle"></i> Error: ${error.message}`, 'error');
            }
        });

        // Test 5: Create Test Notification
        document.getElementById('createTestBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            log('Creating test notification...', 'info');
            updateStatus('createStatus', '<i class="bi bi-hourglass-split"></i> Creating...', 'info');

            try {
                const testNotification = {
                    type: 'claim_request',
                    itemId: 'test-' + Date.now(),
                    itemName: 'Test Item - ' + new Date().toLocaleTimeString(),
                    itemType: 'found',
                    claimerEmail: 'test@rvce.edu.in',
                    originalPosterEmail: user.email,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('notifications').add(testNotification);

                log(`Test notification created with ID: ${docRef.id}`, 'success');
                updateStatus('createStatus',
                    `<i class="bi bi-check-circle"></i> Created test notification!<br>
                    <small>ID: ${docRef.id}</small><br>
                    <small class="text-muted">Go to the main portal to see it in the Notifications section</small>`,
                    'success');
            } catch (error) {
                log(`Create error: ${error.message}`, 'error');
                updateStatus('createStatus', `<i class="bi bi-x-circle"></i> Error: ${error.message}`, 'error');
            }
        });

        // Test 6: Load All Notifications
        document.getElementById('loadAllBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            log('Loading all notifications (all statuses)...', 'info');
            updateStatus('allNotifications', '<i class="bi bi-hourglass-split"></i> Loading...', 'info');

            try {
                const snapshot = await db.collection('notifications')
                    .where('originalPosterEmail', '==', user.email)
                    .get();

                log(`Found ${snapshot.size} total notifications`, 'success');

                let html = `<i class="bi bi-check-circle"></i> Found <strong>${snapshot.size}</strong> total notifications<br>`;

                if (snapshot.size > 0) {
                    html += '<table class="table table-sm mt-2"><thead><tr><th>Item</th><th>Claimer</th><th>Status</th></tr></thead><tbody>';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const statusBadge = {
                            'pending': '<span class="badge bg-warning">Pending</span>',
                            'completed': '<span class="badge bg-success">Completed</span>',
                            'dismissed': '<span class="badge bg-secondary">Dismissed</span>'
                        }[data.status] || data.status;

                        html += `<tr><td>${data.itemName}</td><td>${data.claimerEmail}</td><td>${statusBadge}</td></tr>`;
                        log(`  - ${data.itemName} (${data.status})`, 'info');
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p class="mt-2 mb-0 text-muted">No notifications found. Try creating a test notification above.</p>';
                }

                updateStatus('allNotifications', html, 'success');
            } catch (error) {
                log(`Load error: ${error.message}`, 'error');
                updateStatus('allNotifications', `<i class="bi bi-x-circle"></i> Error: ${error.message}`, 'error');
            }
        });

        log('Test page loaded. Waiting for authentication...', 'info');
    </script>
</body>

</html>